{% extends "base.html" %}

{% block title %}Library - Student{% endblock %}

{% block content %}
<div class="p-4">
  <div class="flex items-center justify-between mb-4 gap-3 flex-col md:flex-row">
    <h1 class="text-2xl font-bold">Library</h1>
  </div>

  <!-- Tabs -->
  <div class="mb-4 border-b border-gray-200">
    <nav class="flex gap-2" role="tablist">
      <button class="px-4 py-2 rounded-t bg-white border border-b-0 tab-btn font-medium" data-tab="tab-all" aria-selected="true"><i class="fas fa-book mr-2"></i>All Books</button>
      <button class="px-4 py-2 rounded-t bg-gray-100 border tab-btn" data-tab="tab-current"><i class="fas fa-book-reader mr-2"></i>My Borrowed</button>
      <button class="px-4 py-2 rounded-t bg-gray-100 border tab-btn" data-tab="tab-history"><i class="fas fa-history mr-2"></i>History</button>
    </nav>
  </div>

  <!-- All Books -->
  <section id="tab-all" class="tab-panel">
    <div class="flex items-center gap-3 mb-3">
      <div class="relative w-full md:w-80">
        <input id="bookSearch" type="text" placeholder="Search by ID, title, or author..." class="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
      </div>
    </div>
    <div class="bg-white rounded shadow overflow-x-auto">
      <table class="min-w-full">
        <thead>
          <tr class="bg-gray-100 text-left">
            <th class="px-4 py-2">Book ID</th>
            <th class="px-4 py-2">Title</th>
            <th class="px-4 py-2">Author</th>
            <th class="px-4 py-2 text-right">Price</th>
            <th class="px-4 py-2 text-center">Status</th>
          </tr>
        </thead>
        <tbody id="booksTbody">
          {% for b in books %}
          <tr class="border-t book-row" data-book-id="{{ b.book_id }}" data-title="{{ b.title }}" data-author="{{ b.author }}" data-status="{{ b.status }}">
            <td class="px-4 py-2 font-mono">{{ b.book_id }}</td>
            <td class="px-4 py-2">{{ b.title }}</td>
            <td class="px-4 py-2">{{ b.author }}</td>
            <td class="px-4 py-2 text-right">{{ '%.2f' % b.price if b.price is not none }}</td>
            <td class="px-4 py-2 text-center">
              <span class="px-2 py-1 rounded text-xs {{ 'bg-green-100 text-green-700' if b.status=='available' else 'bg-yellow-100 text-yellow-700' }}">{{ b.status|capitalize }}</span>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="5" class="px-4 py-6 text-center text-gray-500">No books found</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div id="booksPagination" class="mt-4 flex justify-center"></div>
  </section>

  <!-- My Borrowed -->
  <section id="tab-current" class="tab-panel hidden">
    <div class="bg-white rounded shadow overflow-x-auto">
      <table class="min-w-full">
        <thead>
          <tr class="bg-gray-100 text-left">
            <th class="px-4 py-2">Book ID</th>
            <th class="px-4 py-2">Title</th>
            <th class="px-4 py-2">Issued On</th>
            <th class="px-4 py-2">Due Date</th>
            <th class="px-4 py-2 text-center">Status</th>
          </tr>
        </thead>
        <tbody>
          {% for t in current_transactions %}
          <tr class="border-t">
            <td class="px-4 py-2 font-mono">{{ t.book_id }}</td>
            <td class="px-4 py-2">{{ t.book_title }}</td>
            <td class="px-4 py-2 text-sm">{{ t.issued_at|datetimeformat }}</td>
            <td class="px-4 py-2 text-sm">{{ t.due_at|datetimeformat if t.due_at else '-' }}</td>
            <td class="px-4 py-2 text-center">
              <span class="px-2 py-1 rounded text-xs {{ 'bg-red-100 text-red-700' if t.status=='overdue' else 'bg-yellow-100 text-yellow-700' }}">{{ t.status|capitalize }}</span>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="5" class="px-4 py-6 text-center text-gray-500">No active borrows</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <!-- History -->
  <section id="tab-history" class="tab-panel hidden">
    <div class="bg-white rounded shadow overflow-x-auto">
      <table class="min-w-full">
        <thead>
          <tr class="bg-gray-100 text-left">
            <th class="px-4 py-2">Book ID</th>
            <th class="px-4 py-2">Title</th>
            <th class="px-4 py-2">Issued On</th>
            <th class="px-4 py-2">Returned On</th>
          </tr>
        </thead>
        <tbody>
          {% for t in past_transactions %}
          <tr class="border-t">
            <td class="px-4 py-2 font-mono">{{ t.book_id }}</td>
            <td class="px-4 py-2">{{ t.book_title }}</td>
            <td class="px-4 py-2 text-sm">{{ t.issued_at|datetimeformat }}</td>
            <td class="px-4 py-2 text-sm">{{ t.returned_at|datetimeformat if t.returned_at else '-' }}</td>
          </tr>
          {% else %}
          <tr><td colspan="4" class="px-4 py-6 text-center text-gray-500">No past transactions</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  // Tabs logic
  const buttons = Array.from(document.querySelectorAll('.tab-btn'));
  const panels = {
    'tab-all': document.getElementById('tab-all'),
    'tab-current': document.getElementById('tab-current'),
    'tab-history': document.getElementById('tab-history')
  };
  function activate(tab){
    Object.entries(panels).forEach(([k,el])=> el.classList.toggle('hidden', k!==tab));
    buttons.forEach(b=>{
      const active = b.dataset.tab === tab;
      b.setAttribute('aria-selected', active ? 'true' : 'false');
      b.className = 'px-4 py-2 rounded-t border ' + (active ? 'bg-white border-b-0 font-medium' : 'bg-gray-100');
    });
  }
  buttons.forEach(b=> b.addEventListener('click', ()=> activate(b.dataset.tab)));
  activate('tab-all');

  const rows = Array.from(document.querySelectorAll('.book-row'));
  const search = document.getElementById('bookSearch');
  const pager = document.getElementById('booksPagination');
  const perPage = 10;
  let currentRows = [];
  let current = 1;

  function applyFilter(){
    const q = (search?.value || '').trim().toLowerCase();
    currentRows = rows.filter(tr => {
      const id = (tr.dataset.bookId||'').toLowerCase();
      const title = (tr.dataset.title||'').toLowerCase();
      const author = (tr.dataset.author||'').toLowerCase();
      return !q || id.includes(q) || title.includes(q) || author.includes(q);
    }).sort((a,b)=> (a.dataset.title||'').localeCompare(b.dataset.title||'', undefined, {sensitivity:'base'}));
    renderPage(1);
  }

  function renderPage(n){
    rows.forEach(tr=> tr.style.display='none');
    const totalPages = Math.max(1, Math.ceil(currentRows.length / perPage));
    current = Math.min(Math.max(1,n), totalPages);
    const start = (current-1)*perPage;
    const end = start + perPage;
    currentRows.slice(start,end).forEach(tr=> tr.style.display='');
    renderPager(totalPages);
  }

  function renderPager(totalPages){
    if(!pager) return;
    pager.innerHTML = '';
    if(currentRows.length === 0) return;

    // Container with horizontal scroll on small screens
    const wrap = document.createElement('div');
    wrap.className = 'max-w-full overflow-x-auto';

    const nav = document.createElement('nav');
    nav.className = 'inline-flex rounded-md shadow bg-white';

    const mkBtn = (label, onClick, disabled=false, active=false, extraClass='') => {
      const b = document.createElement('button');
      b.type = 'button'
      b.className = (active
        ? 'px-3 py-2 border border-gray-300 bg-blue-600 text-white font-medium '
        : 'px-3 py-2 border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 ') + extraClass;
      b.innerHTML = label;
      b.disabled = !!disabled;
      if(onClick) b.onclick = onClick;
      return b;
    };

    // Prev
    nav.appendChild(mkBtn('<i class="fas fa-chevron-left"></i>', ()=> renderPage(current-1), current===1));

    // Compute windowed pages: first, last, current±2 with ellipses
    const pages = new Set([1, totalPages]);
    for(let i=Math.max(1, current-2); i<=Math.min(totalPages, current+2); i++) pages.add(i);
    const sorted = Array.from(pages).sort((a,b)=>a-b);

    let prevPage = null;
    sorted.forEach(p => {
      if(prevPage && p !== prevPage + 1){
        // Ellipsis that jumps by -5/+5 around current
        nav.appendChild(mkBtn('…', ()=> renderPage(p>current ? Math.min(totalPages, current+5) : Math.max(1, current-5)), false, false, 'min-w-[2.5rem]'));
      }
      nav.appendChild(mkBtn(String(p), ()=> renderPage(p), false, p===current));
      prevPage = p;
    });

    // Next
    nav.appendChild(mkBtn('<i class="fas fa-chevron-right"></i>', ()=> renderPage(current+1), current>=totalPages));

    wrap.appendChild(nav);

    // Quick jump select for very large page counts (shown on mobile only)
    if(totalPages > 20){
      const jumpWrap = document.createElement('div');
      jumpWrap.className = 'mt-2 md:mt-0 md:ml-3 flex justify-center md:inline-flex';
      const sel = document.createElement('select');
      sel.className = 'block md:hidden border rounded px-2 py-2';
      for(let i=1;i<=totalPages;i++){
        const opt = document.createElement('option');
        opt.value = i; opt.text = 'Page ' + i; if(i===current) opt.selected = true; sel.appendChild(opt);
      }
      sel.onchange = () => renderPage(parseInt(sel.value));
      jumpWrap.appendChild(sel);
      wrap.appendChild(jumpWrap);
    }

    pager.appendChild(wrap);
  }

  if(search) search.addEventListener('input', applyFilter);
  applyFilter();
})();
</script>
{% endblock %}
